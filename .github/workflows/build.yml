name: Build and Release

on:
  push:
    branches: [ "main", "master" ]
    tags:
      - 'v*' 
  pull_request:
    branches: [ "main", "master" ]
  workflow_dispatch:

permissions:
  contents: write

env:
  CARGO_TERM_COLOR: always

jobs:
  build:
    name: Build Linux Bundle
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    # 1. Install Linux Build Dependencies
    - name: Install All dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y clang cmake ninja-build pkg-config libgtk-3-dev liblzma-dev libstdc++-12-dev libwayland-dev libxkbcommon-dev pkg-config

    # 2. Set up Rust
    - name: Install Rust toolchain
      uses: dtolnay/rust-toolchain@stable

    # 3. Set up Flutter
    - name: Set up Flutter
      uses: subosito/flutter-action@v2
      with:
        channel: 'stable'
        cache: true

    # 4. Build Rust CLI
    - name: Build Rust Backend
      run: cargo build --release --verbose

    # 5. Build Flutter GUI
    - name: Build Flutter Frontend
      run: |
        cd gui
        flutter pub get
        flutter build linux --release

    # 6. Bundle everything together
    - name: Package Release
      run: |
        # Create a staging directory
        mkdir -p wayclicker-release
        
        # Copy Flutter bundle (binary, libs, data)
        cp -r gui/build/linux/x64/release/bundle/* wayclicker-release/
        
        # Copy Rust binary into the same folder
        cp target/release/wayclicker wayclicker-release/
        
        # Zip it up
        tar -czvf wayclicker-linux-x64.tar.gz wayclicker-release/

    # 7. Upload Artifact (For every push)
    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: wayclicker-linux-bundle
        path: wayclicker-linux-x64.tar.gz

    # 8. Create Release (Only on Tags)
    - name: Release
      uses: softprops/action-gh-release@v1
      if: startsWith(github.ref, 'refs/tags/')
      with:
        files: wayclicker-linux-x64.tar.gz
        generate_release_notes: true
